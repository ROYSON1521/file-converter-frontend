<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Converter App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
    }
    .card {
      background: #fff;
      padding: 25px;
      width: 350px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      display: none;
      animation: fade 0.3s ease-in-out;
    }
    .card.active {
      display: block;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 12px;
    }
    button:hover {
      background: #5a67d8;
    }
    .note {
      font-size: 12px;
      text-align: center;
      color: #666;
    }
    .spinner {
      border: 4px solid #eee;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
}
body, .card, input, select, button {
  transition: background-color 0.3s ease, color 0.3s ease;
}

/* üåô Dark mode styles */
body.dark {
  background: linear-gradient(135deg, #1f2933, #111827);
  color: #e5e7eb;
}

body.dark .card {
  background: #1f2933;
  color: #e5e7eb;
}

body.dark input,
body.dark select {
  background: #111827;
  color: #e5e7eb;
  border: 1px solid #374151;
}

body.dark button {
  background: #4f46e5;
}

body.dark .note {
  color: #9ca3af;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
@keyframes fade {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
/* üåó Theme toggle switch */
.theme-toggle {
  display: flex;
  justify-content: center;
  margin: 10px 0 15px;
}

.switch {
  position: relative;
  width: 52px;
  height: 26px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  inset: 0;
  background-color: #cbd5e1;
  border-radius: 34px;
  transition: background-color 0.3s;
}

.slider::before {
  content: "üåû";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.3s;
  font-size: 14px;
}

/* checked = dark mode */
.switch input:checked + .slider {
  background-color: #4f46e5;
}

.switch input:checked + .slider::before {
  transform: translateX(26px);
  content: "üåô";
}

  </style>
</head>
<body>

  <!-- Login Page -->
  <div class="card active" id="loginCard">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
     <p class="note">
    Don‚Äôt have an account?
    <a href="#" onclick="showRegister()">Register</a>
  </p>
  </div>

   <!-- Register Page -->
<div class="card" id="registerCard">
  <h2>Register</h2>
  <input type="text" id="registerUsername" placeholder="Username" />
  <input type="password" id="registerPassword" placeholder="Password" />
  <button onclick="register()">Register</button>
  <p class="note">
    Already have an account?
    <a href="#" onclick="showLogin()">Login</a>
  </p>
</div>

  <!-- File Converter Page -->
  <div class="card" id="converterCard">
    <h2>File Converter</h2>
    <p class="note" id="welcomeUser"></p>
    <input type="file" id="fileInput" accept=".txt,.pdf,.docx,.png,.jpg,.jpeg"/>
    <select id="format">
      <option value="txt_to_pdf">TXT ‚Üí PDF</option>
      <option value="txt_to_docx">TXT ‚Üí DOCX</option>
      <option value="pdf_to_txt">PDF ‚Üí TXT</option>
      <option value="docx_to_txt">DOCX ‚Üí TXT</option>
      <option value="pdf_to_docx">PDF ‚Üí DOCX</option>
    </select>
    <button id="convertBtn" onclick="convertFile()">Convert</button>
    <button id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
    <div id="status" class="note"></div>
    
  </div>

  <script>
const API_URL = "https://file-converter-backend-0tg6.onrender.com/convert";
const REGISTER_API = "https://file-converter-backend-0tg6.onrender.com/register";
const LOGIN_API = "https://file-converter-backend-0tg6.onrender.com/login";
const extMap = {
  txt_to_pdf: "pdf",
  txt_to_docx: "docx",
  pdf_to_txt: "txt",
  docx_to_txt: "txt",
  pdf_to_docx: "docx"
};

// üîí Bonus fix: auto-login after refresh (DOM safe)
window.addEventListener("DOMContentLoaded", () => {
  // üåó sync theme toggle
   const savedTheme = localStorage.getItem("theme");
if (savedTheme === "dark") {
  document.body.classList.add("dark");
  document.getElementById("themeSwitch").checked = true;
}

// ‚úÖ auto-login check
  if (localStorage.getItem("loggedIn") === "true") {
    document.getElementById("loginCard").classList.remove("active");
    document.getElementById("registerCard").classList.remove("active");
    document.getElementById("converterCard").classList.add("active");

    document.getElementById("welcomeUser").textContent =
      "Welcome, " + localStorage.getItem("username");
  }
});

// üåó Dark / Light mode toggle
function toggleTheme() {
  const isDark = document.body.classList.toggle("dark");

  localStorage.setItem("theme", isDark ? "dark" : "light");
  document.getElementById("themeSwitch").checked = isDark;
}

// üîÅ STEP 2: page switching logic
function showRegister() {
  document.getElementById("loginCard").classList.remove("active");
  document.getElementById("registerCard").classList.add("active");
}

function showLogin() {
  document.getElementById("registerCard").classList.remove("active");
  document.getElementById("loginCard").classList.add("active");
}

async function login() {
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();

  if (!user || !pass) {
    alert("Enter username and password");
    return;
  }
  try {
    const res = await fetch(LOGIN_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user, password: pass })
    });
    const data = await res.json();
    localStorage.setItem("token", data.token);
    localStorage.setItem("username", user);
    localStorage.setItem("loggedIn", "true");
  
    if (!res.ok) throw new Error(data.message);
   
    document.getElementById("welcomeUser").textContent = "Welcome, " + user;
    document.getElementById("logoutBtn").style.display = "block";
    document.getElementById("loginCard").classList.remove("active");
    document.getElementById("converterCard").classList.add("active");
    document.getElementById("username").value = "";
    document.getElementById("password").value = "";
  } catch (err) {
    alert("Login failed: " + err.message);
  }
}

async function register() {
  const user = document.getElementById("registerUsername").value.trim();
  const pass = document.getElementById("registerPassword").value.trim();

  if (!user || !pass) {
    alert("Enter username and password");
    return;
  }

  try {
    const res = await fetch(REGISTER_API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username: user, password: pass })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.message);

    alert("Registration successful. Please login.");
    document.getElementById("registerUsername").value = "";
    document.getElementById("registerPassword").value = "";
    showLogin(); 

  } catch (err) {
    alert("Registration failed: " + err.message);
  }
}

// üö™ STEP 3.3: Logout
function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("username");

  document.getElementById("converterCard").classList.remove("active");
  document.getElementById("registerCard").classList.remove("active");
  document.getElementById("loginCard").classList.add("active");
  document.getElementById("themeSwitch").checked = document.body.classList.contains("dark");
}

async function convertFile() {
    const token = localStorage.getItem("token");
    if (!token) {
        alert("Session expired. Please login again.");
        logout();
     return;
    }
  const fileInput = document.getElementById('fileInput');

  // ‚úÖ 1. Check if file exists FIRST
  if (!fileInput.files.length) {
    alert("Please select a file");
    return;
  }

  const file = fileInput.files[0];
  const originalName = file.name.split(".").slice(0, -1).join(".");

  // ‚úÖ 2. File validation
  const allowedTypes = [
    "application/pdf",
    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "text/plain",
    "image/png",
    "image/jpeg"
  ];

  const maxSize = 5 * 1024 * 1024; // 5MB

  if (!allowedTypes.includes(file.type)) {
    alert("Invalid file type. Upload PDF, DOCX, TXT, JPG or PNG.");
    return;
  }

  if (file.size > maxSize) {
    alert("File size exceeds 5MB limit.");
    return;
  }

  const format = document.getElementById('format').value;

  // ‚úÖ 3. Send to backend
  // STEP 2: show spinner + disable button
  const status = document.getElementById("status");
  const btn = document.getElementById("convertBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  status.innerHTML = '<div class="spinner"></div><p>Converting...</p>';
  btn.disabled = true;
  logoutBtn.disabled = true;
  
  const formData = new FormData();
  formData.append("file", file);
  formData.append("format", format);

  try {
    const token = localStorage.getItem("token");
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
    "Authorization": "Bearer " + token
     },
      body: formData
    });

    if (!response.ok) {
      const text = await response.text();
      throw new Error(text || "Upload failed");
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `${originalName}.${extMap[format]}`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    // STEP 3: success message + enable button
    status.textContent = "Conversion successful ‚úÖ";
    btn.disabled = false;
    logoutBtn.disabled = false;
    logoutBtn.style.display = "block";

  } catch (error) {
    status.textContent = "Conversion failed ‚ùå";
    btn.disabled = false;
    logoutBtn.disabled = false;
    logoutBtn.style.display = "block";
    alert("Error: " + error.message);
  }
}
  </script>
</body>
</html>
